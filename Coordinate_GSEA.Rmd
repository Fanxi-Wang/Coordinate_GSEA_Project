---
title: "Coordinate_GSEA"
author: "Fanxi Wang"
date: "2025-10-22"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
```


```{r}
# =============================================================
# Coordinate Model GSEA Analysis
# (1) Non-directional GSEA  – based on significant gene counts
# (2) Directional GSEA      – based on log2FoldChange ranking
# =============================================================

# Load packages
library(data.table)
library(dplyr)
library(clusterProfiler)
library(org.Hs.eg.db)
library(GO.db)
library(fgsea)
library(ggplot2)
library(tibble)
library(reshape2)
library(gsEasy)
library(AnnotationDbi)

# Step 1: Load DESeq2 results
results_coord <- fread("~/Desktop/BDS-Capstone/GSEA/CLAM_Possion/deseq_with_attention_simulated_new_coordinate.csv")
gene_names_coord <- results_coord[[1]]
results_coord <- results_coord[, -1]
rownames(results_coord) <- gene_names_coord
results_coord$ID <- gene_names_coord
results_coord <- results_coord %>% filter(!is.na(log2FoldChange) & !is.na(pvalue))

# =============================================================
# Part 1: Non-directional GSEA
# =============================================================

results_coord <- results_coord %>% arrange(pvalue)
mapping_coord <- bitr(results_coord$ID, fromType = "SYMBOL", toType = "GO", OrgDb = "org.Hs.eg.db")
mod.gs_coord <- tapply(mapping_coord$GO, mapping_coord$SYMBOL, as.character)
geneSet_coord <- inverseList(mod.gs_coord)

run_GSEA <- function(geneSet, ranked_features, filter.count = 10, seed = 1234) {
  cond <- sapply(geneSet, function(x) length(x) > filter.count)
  geneSet <- geneSet[cond]
  len <- as.data.frame(melt(lapply(geneSet, length)))
  colnames(len) <- c("Freq", "Set")
  set.seed(seed)
  enrich <- as.data.frame(sapply(geneSet, function(set) gsEasy::gset(S = set, r = ranked_features)))
  colnames(enrich) <- "ES"
  enrich <- tibble::rownames_to_column(enrich, "Set")
  enrich <- merge(enrich, len, by = "Set")
  enrich$qval <- p.adjust(enrich$ES, method = "BH")
  return(enrich)
}

GSEA_coord <- run_GSEA(geneSet_coord, ranked_features = rownames(results_coord))
top35_coord <- GSEA_coord %>% arrange(qval) %>% slice_head(n = 35)

ggplot(top35_coord, aes(x = reorder(Set, -qval), y = -log10(qval))) +
  geom_bar(stat = "identity", fill = "steelblue") +
  coord_flip() +
  theme_bw() +
  labs(title = "Top 35 Enriched GO Terms (Coordinate Model)",
       x = "", y = "-log10(q-value)")

# =============================================================
# Part 2: Directional GSEA
# =============================================================

ranked_genes_coord <- results_coord$log2FoldChange
names(ranked_genes_coord) <- results_coord$ID
ranked_genes_coord <- sort(ranked_genes_coord, decreasing = TRUE)

mapping_coord2 <- bitr(names(ranked_genes_coord), fromType = "SYMBOL", toType = "GO", OrgDb = "org.Hs.eg.db")
geneSet_coord2 <- split(mapping_coord2$SYMBOL, mapping_coord2$GO)

set.seed(1234)
fgsea_res_coord <- fgsea(pathways = geneSet_coord2, stats = ranked_genes_coord)

GSEA_coord_fgsea <- fgsea_res_coord %>%
  select(pathway, NES, pval, padj) %>%
  arrange(padj)

mapping_info_coord <- AnnotationDbi::select(GO.db,
                                            keys = unique(GSEA_coord_fgsea$pathway),
                                            columns = c("TERM", "ONTOLOGY"),
                                            keytype = "GOID") %>%
  distinct(GOID, .keep_all = TRUE) %>%
  rename(pathway = GOID, Name = TERM, Ontology = ONTOLOGY)

GSEA_coord_fgsea <- left_join(GSEA_coord_fgsea, mapping_info_coord, by = "pathway")

# Top 10 Up & Down 
top10_pos <- GSEA_coord_fgsea %>% filter(NES > 0) %>% arrange(padj) %>% slice_head(n = 10)
top10_neg <- GSEA_coord_fgsea %>% filter(NES < 0) %>% arrange(padj) %>% slice_head(n = 10)

# Plots
ggplot(top10_pos, aes(x = Name, y = NES, fill = padj)) +
  geom_bar(stat = "identity") +
  coord_flip() +
  scale_fill_gradient(low = "steelblue", high = "firebrick") +
  theme_bw() +
  labs(title = "Top 10 Positively Enriched GO Terms (High-attention)",
       x = "", y = "NES")

ggplot(top10_neg, aes(x = Name, y = NES, fill = padj)) +
  geom_bar(stat = "identity") +
  coord_flip() +
  scale_fill_gradient(low = "darkgreen", high = "orange") +
  theme_bw() +
  labs(title = "Top 10 Negatively Enriched GO Terms (Low-attention)",
       x = "", y = "NES")

combined_coord <- bind_rows(
  top10_pos %>% mutate(Direction = "Up (High attention)"),
  top10_neg %>% mutate(Direction = "Down (Low attention)")
)

ggplot(combined_coord, aes(x = Name, y = NES, fill = Direction)) +
  geom_bar(stat = "identity") +
  coord_flip() +
  scale_fill_manual(values = c("Up (High attention)" = "#e41a1c",
                               "Down (Low attention)" = "#377eb8")) +
  theme_bw(base_size = 12) +
  labs(title = "Top Enriched GO Terms by Attention Direction (Coordinate Model)",
       x = "", y = "Normalized Enrichment Score (NES)") +
  theme(legend.position = "top")


```

